!function(){"use strict";class t{constructor(t){this._read=t.read,this._write=t.write,this._reset=t.reset;const e={int16Count:0,int32Count:0,float32Count:0};this._multiTypeBufferParams=e,this._reset({writeInt16:t=>e.int16Count++,writeMultipleInt16:(...t)=>e.int16Count+=t.length,writeInt32:t=>e.int32Count++,writeMultipleInt32:(...t)=>e.int32Count+=t.length,writeFloat32:t=>e.float32Count++,writeMultipleFloat32:(...t)=>e.float32Count+=t.length})}createComponentRawArray(e){return new t.StructComponentRawArray(e,this)}}t.StructComponentRawArray=class{constructor(t,n){this._cursor=0,this.capacity=t,this._structDefine=n;const r={int16Count:n._multiTypeBufferParams.int16Count*t,int32Count:n._multiTypeBufferParams.int32Count*t,float32Count:n._multiTypeBufferParams.float32Count*t};this._buffer=new e(r)}set cursor(t){if(t===this._cursor)return;const{_multiTypeBufferParams:e}=this._structDefine,n=this._buffer;n.int16Offset=e.int16Count*t,n.int32Offset=e.int32Count*t,n.float32Offset=e.float32Count*t,this._cursor=t}get cursor(){return this._cursor}read(){const t=this._structDefine._read(this._buffer);return this._cursor++,t}write(t){this._structDefine._write(this._buffer,t),this._cursor++}reset(){this._structDefine._reset(this._buffer),this._cursor++}};class e{constructor({int16Count:t=0,int32Count:e=0,float32Count:n=0}){this.int16Offset=0,this._int16Array=null,this.int32Offset=0,this._int32Array=null,this.float32Offset=0,this._float32Array=null,t>0&&(this._int16Array=new Int16Array(t),this.int16Offset=0),e>0&&(this._int32Array=new Int32Array(e),this.int32Offset=0),n>0&&(this._float32Array=new Float32Array(n),this.float32Offset=0)}readInt16(){if(null===this._int16Array)throw new Error("No int16Array");const[t,e,n,r]=this._int16Array;return this._int16Array[this.int16Offset++]}*readMultipleInt16(t){const e=this._int16Array;if(null===e)throw new Error("No int16Array");const n=this.int16Offset,r=this.int16Offset+t;this.int16Offset=r;for(let t=n;t<r;++t)yield e[t];return t}writeInt16(t){if(null===this._int16Array)throw new Error("No int16Array");this._int16Array[this.int16Offset++]=t}writeMultipleInt16(...t){const e=this._int16Array;if(null===e)throw new Error("No int16Array");const n=this.int16Offset,r=t.length;for(let i=0;i<r;++i)e[i+n]=t[i];this.int16Offset=n+r}readInt32(){if(null===this._int32Array)throw new Error("No int32Array");return this._int32Array[this.int32Offset++]}*readMultipleInt32(t){const e=this._int32Array;if(null===e)throw new Error("No int32Array");const n=this.int32Offset,r=this.int32Offset+t;this.int32Offset=r;for(let t=n;t<r;++t)yield e[t];return t}writeInt32(t){if(null===this._int32Array)throw new Error("No int32Array");this._int32Array[this.int32Offset++]=t}writeMultipleInt32(...t){const e=this._int32Array;if(null===e)throw new Error("No int32Array");const n=this.int32Offset,r=t.length;for(let i=0;i<r;++i)e[i+n]=t[i];this.int32Offset=n+r}readFloat32(){if(null===this._float32Array)throw new Error("No float32Array");return this._float32Array[this.float32Offset++]}*readMultipleFloat32(t){const e=this._float32Array;if(null===e)throw new Error("No float32Array");const n=this.float32Offset,r=this.float32Offset+t;this.float32Offset=r;for(let t=n;t<r;++t)yield e[t];return t}writeFloat32(t){if(null===this._float32Array)throw new Error("No float32Array");this._float32Array[this.float32Offset++]=t}writeMultipleFloat32(...t){const e=this._float32Array;if(null===e)throw new Error("No float32Array");const n=this.float32Offset,r=t.length;for(let i=0;i<r;++i)e[i+n]=t[i];this.float32Offset=n+r}}class n{constructor(t,e){this.cursor=0,this.capacity=t,this._singleton=e}read(){return this.cursor++,this._singleton}write(t){this.cursor++}reset(){this.cursor++}}class r{constructor(t,e){this.entityId=t,this.version=e}toString(){return`Entity(${this.entityId}, ${this.version})`}static createRawArray(t){return r.structDefine.createComponentRawArray(t)}}r.structDefine=new t({read(t){const e=t.readInt16(),n=t.readInt16();return new r(e,n)},write(t,e){t.writeInt16(e.entityId),t.writeInt16(e.version)},reset(t){t.writeInt16(0),t.writeInt16(0)}});class i{static createRawArray(t){return new n(t,i.instance)}}i.instance=new i;class o{constructor(t,e,n){this.x=t||0,this.y=e||0,this.z=n||0}static createRawArray(t){return o.structDefine.createComponentRawArray(t)}}o.structDefine=new t({read(t){const e=new o;return[e.x,e.y,e.z]=[...t.readMultipleFloat32(3)],e},write(t,e){t.writeMultipleFloat32(e.x,e.y,e.z)},reset(t){t.writeMultipleFloat32(0,0,0)}});class s{constructor(t){this._count=0,this._componentRawArray=t}get capacity(){return this._componentRawArray.capacity}get count(){return this._count}add(t){if(this._count>=this._componentRawArray.capacity)throw new Error("Reach full capacity");const e=this._count;return this._componentRawArray.cursor=e,void 0===t?this._componentRawArray.reset():this._componentRawArray.write(t),this._count=e+1,e}remove(t){if(t>=this._count||t<0)throw new Error("Remove exceed boundary");const e=this._count-1;if(t===e)return this._count--,null;this._componentRawArray.cursor=e;const n=this._componentRawArray.read();return this._componentRawArray.cursor=t,this._componentRawArray.write(n),this._count=e,n}get(t){if(t>=this._count||t<0)throw new Error("Get exceed boundary");return this._componentRawArray.cursor=t,this._componentRawArray.read()}set(t,e){if(t>=this._count||t<0)throw new Error("Set exceed boundary");this._componentRawArray.cursor=t,this._componentRawArray.write(e)}*[Symbol.iterator](){let t=0;for(let e=0;e<this._count;++e)++t,yield this.get(e);return t}}class a{constructor(t,e){this.archetypeString=t,this.componentCtors=e,this._entityDataArray=[],this._componentDataArrayMap=new Map;for(const t of e)this._componentDataArrayMap.set(t.name,[]);this._chunkArray=[],this._systemStateComponentCtors=null,this._componentCtorMap=null,this._entityCount=0}static createEmpty(){return new a("type<>",[])}get entityCount(){return this._entityCount}getSystemStateComponentCtors(){let t=this._systemStateComponentCtors;if(null===t){t=new Array,this._systemStateComponentCtors=t;for(const e of this.componentCtors)e.isSystemState&&t.push(e)}return t}iterChunks(){return this._chunkArray[Symbol.iterator]()}getChunk(t){return this._chunkArray[t]}addEntityData(t,e){let n=0,r=null;const i=this._chunkArray;for(let t=0;t<i.length;++t){const e=i[t];if(!e.isFull){n=t,r=e;break}}null===r&&(r=this._createChunk(),n=i.length,i.push(r));const o=r.addEntity(t,e);return this._entityCount++,{chunkIndex:n,entityIndex:o}}removeEntityData(t,e){const n=this._chunkArray[t].removeEntity(e);return this._entityCount--,n}_createChunk(){const t=a._chunkCapacity,e=r.createRawArray(t),n=this._entityDataArray.length;this._entityDataArray.push(new s(e));for(const e of this.componentCtors){const n=e.createRawArray(t),r=this._componentDataArrayMap.get(e.name);if(void 0===r)throw new Error("No componentDataArray for "+e.name);r.push(new s(n))}return new c(this._entityDataArray,this._componentDataArrayMap,this.componentCtors,n)}_getComponentCtorMap(){let t=this._componentCtorMap;if(null===t){t=new Map,this._componentCtorMap=t;for(const e of this.componentCtors)t.set(e.name,e)}return t}hasComponent(t){return this._getComponentCtorMap().has(t.name)}matchQuery({include:t,exclude:e}){const n=this._getComponentCtorMap();for(const e of t)if(!n.has(e.name))return!1;if(e)for(const t of e)if(n.has(t.name))return!1;return!0}}a._chunkCapacity=512;class c{constructor(t,e,n,r){this._entityDataArray=t,this._componentDataArrayMap=e,this._componentCtors=n,this._chunkIndex=r}get isFull(){const t=this._entityDataArray[this._chunkIndex];return t.count>=t.capacity}get capacity(){return this._entityDataArray[this._chunkIndex].capacity}get count(){return this._entityDataArray[this._chunkIndex].count}getDataArray(t){const e=this._componentDataArrayMap.get(t.name);return e?e[this._chunkIndex]:null}getEntityArray(){return this._entityDataArray[this._chunkIndex]}addEntity(t,e){const n=this._chunkIndex,r=this._entityDataArray[n].add(e),i=this._componentDataArrayMap;for(const e of this._componentCtors){const{name:r}=e,o=i.get(r);if(void 0===o)throw new Error("No compnentDataArray for "+r);o[n].add(t.get(r))}return r}removeEntity(t){const e=this._chunkIndex,n=this._entityDataArray[e].remove(t),r=this._componentDataArrayMap;for(const n of this._componentCtors){const{name:i}=n,o=r.get(i);if(void 0===o)throw new Error("No compnentDataArray for "+i);o[e].remove(t)}return n}}class h{constructor(){this._archetypeMap=new Map,this._version=1}get version(){return this._version}getArchetype(t,e=!0){const{archetypeString:n,sortedComponentCtors:r}=function(t,e){const n=e?[...t,i]:[...t];if(0===n.length)throw new Error("componentCtors.length == 0");n.sort(function(t,e){return t.name<e.name?-1:t.name>e.name?1:0});let r=null;for(const t of n){if(null!==r&&r.name===t.name)throw new Error("Duplicated component "+t.name);r=t}return{archetypeString:"type<"+n.join(",")+">",sortedComponentCtors:n}}(t,e);if(this._archetypeMap.has(n))return this._archetypeMap.get(n);{const t=new a(n,r);return this._archetypeMap.set(n,t),this._version++,t}}archetypes(){return this._archetypeMap.values()}}class u{constructor(t,e){this.cursor=0,this.capacity=t,this._array=[],this._array.length=t,this._defaultValue=e}read(){return this._array[this.cursor++]}write(t){this._array[this.cursor++]=t}reset(){this._array[this.cursor++]=this._defaultValue}}class l{constructor(){this._availableIdArray=new Array,this._entityInfoArray=[{archetype:a.createEmpty(),chunkIndex:0,entityIndex:0,version:0}]}addEntity(t,e,n){const i=this._availableIdArray,o=this._entityInfoArray;let s,a;if(i.length>0){const r=o[s=i.pop()];r.archetype=t,r.chunkIndex=e,r.entityIndex=n,a=r.version}else s=o.length,a=1,o.push({archetype:t,chunkIndex:e,entityIndex:n,version:a});const c=new r(s,a);return t.getChunk(e).getEntityArray().set(n,c),c}removeEntity(t){const e=this._entityInfoArray[t.entityId];if(e.version!==t.version)throw new Error("Entity version expired");e.version++,this._availableIdArray.push(t.entityId)}getEntityInfo(t){const e=this._entityInfoArray[t.entityId];return e.version===t.version?e:null}}class y{constructor(t){this._componentDataArray=t}*[Symbol.iterator](){for(const t of this._componentDataArray){const e=t.constructor,n=e;if(!n.createRawArray)throw new Error(`Class ${e.name} is missing static method createRawArray`);yield n}return this._componentDataArray.length}}class f{constructor(){this._tmpDataMap=new Map,this._queryMap=new Map,this._archetypeDatabase=new h,this._entityIdManger=new l}getArchetype(...t){return this._archetypeDatabase.getArchetype(t)}createEntityOfArchetype(t,...e){const n=this._tmpDataMap;for(const t of e)n.set(t.constructor.name,t);const{chunkIndex:r,entityIndex:i}=t.addEntityData(n);return n.clear(),this._entityIdManger.addEntity(t,r,i)}createEntity(...t){if(0===t.length)throw new Error("Can not add empty entity");const e=this._archetypeDatabase.getArchetype(new y(t));return this.createEntityOfArchetype(e,...t)}static*_getComponentData(t,e,n,r){const i=t.getChunk(e);let o=0;for(const t of r){const e=i.getDataArray(t);if(null===e)throw new Error("No componentDataArray for "+t.name);yield e.get(n),++o}return o}hasComponent(t,e){const n=this._entityIdManger.getEntityInfo(t);if(!n)throw new Error("Invalid entity "+t);const{archetype:r}=n;return r.hasComponent(e)}getComponentData(t,...e){const n=this._entityIdManger.getEntityInfo(t);if(!n)throw new Error("Invalid entity "+t);const{archetype:r,chunkIndex:i,entityIndex:o}=n;return f._getComponentData(r,i,o,e)}addComponent(t,...e){const n=this._entityIdManger.getEntityInfo(t);if(!n)return console.trace("Invalid entity ",t),!1;const{archetype:r,chunkIndex:i,entityIndex:o}=n,s=new Map;for(const t of r.componentCtors)s.set(t.name,t);const a=new Map;for(const n of e){const e=n.constructor;if(!e.createRawArray)return console.trace(e,"is not a component class, in addComponent ",t),!1;if(s.has(e.name))return console.trace(e," has already add to entity, in addComponent ",t),!1;s.set(e.name,e),a.set(e.name,n)}let c=0;for(const t of f._getComponentData(r,i,o,r.componentCtors)){const e=r.componentCtors[c++];a.set(e.name,t)}const h=r.removeEntityData(i,o);if(h){const t=this._entityIdManger.getEntityInfo(h);if(null===t)throw new Error("Invalid entity "+h);t.entityIndex=o}const u=this._archetypeDatabase.getArchetype(s.values(),!1),{chunkIndex:l,entityIndex:y}=u.addEntityData(a,t);return n.archetype=u,n.chunkIndex=l,n.entityIndex=y,!0}removeComponent(t,...e){const n=this._entityIdManger,r=n.getEntityInfo(t);if(!r)return console.trace("Invalid entity ",t),!1;const{archetype:i,chunkIndex:o,entityIndex:s}=r,a=new Map;for(const t of i.componentCtors)a.set(t.name,t);for(const n of e){if(!a.has(n.name))return console.trace(n," dose not exist in entity, in removeComponent ",t),!1;a.delete(n.name)}const c=new Map;let h=0;const u=[...a.values()];for(const t of f._getComponentData(i,o,s,u)){const e=u[h++];c.set(e.name,t)}const l=i.removeEntityData(o,s);if(l){const t=n.getEntityInfo(l);if(null===t)throw new Error("Invalid entity "+l);t.entityIndex=s}if(0===a.size)n.removeEntity(t);else{const e=this._archetypeDatabase.getArchetype(u,!1),{chunkIndex:n,entityIndex:i}=e.addEntityData(c,t);r.archetype=e,r.chunkIndex=n,r.entityIndex=i}return!0}deleteEntity(t){const e=this._entityIdManger,n=e.getEntityInfo(t);if(!n)return console.trace("Invalid entity ",t),!1;const{archetype:r,chunkIndex:i,entityIndex:o}=n,s=r.getSystemStateComponentCtors();if(0===s.length)e.removeEntity(t);else{const e=new Map;let a=0;for(const t of f._getComponentData(r,i,o,s)){const n=s[a++];e.set(n.name,t)}const c=this._archetypeDatabase.getArchetype(s,!1),{chunkIndex:h,entityIndex:u}=c.addEntityData(e,t);n.archetype=c,n.chunkIndex=h,n.entityIndex=u}const a=r.removeEntityData(i,o);if(a){const t=e.getEntityInfo(a);if(null===t)throw new Error("Invalid entity "+a);t.entityIndex=o}return!0}getQuery(t){const e=new Array;for(const n of t.include)e.push(n.name);e.sort();let n="";if(t.exclude){const e=new Array;for(const n of t.exclude)e.push(n.name);e.sort(),n=",e="+e.join(",")}const r=`query<i=${e.join(",")}${n}>`;let i=this._queryMap.get(r);return i||(i=0===e.length&&""===n?new p(this._archetypeDatabase):new d(this._archetypeDatabase,t),this._queryMap.set(r,i)),i}}class d{constructor(t,e){this._matchedArchetypeArray=null,this._version=0,this._archetypeDatabase=t,this._queryDefine=e}_getMatchedArchetypeArray(){let t=this._matchedArchetypeArray;if(this._version!==this._archetypeDatabase.version){t=[],this._matchedArchetypeArray=t;for(const e of this._archetypeDatabase.archetypes())e.matchQuery(this._queryDefine)&&t.push(e);this._version=this._archetypeDatabase.version}return t}isEmptyIgnoreFilter(){for(const t of this._getMatchedArchetypeArray())if(0!==t.entityCount)return!1;return!0}*iterChunks(){let t=0;for(const e of this._getMatchedArchetypeArray())if(0!==e.entityCount)for(const n of e.iterChunks())0!==n.count&&(yield n,++t);return t}}class p{constructor(t){this._archetypeDatabase=t}isEmptyIgnoreFilter(){for(const t of this._archetypeDatabase.archetypes())if(0!==t.entityCount)return!1;return!0}*iterChunks(){let t=0;for(const e of this._archetypeDatabase.archetypes())if(0!==e.entityCount)for(const n of e.iterChunks())0!==n.count&&(yield n,++t);return t}}class g{constructor(t,e=1/30,n=2){this._nextTickTime=void 0,this._logicDelayTime=0,this.entityManager=new f;const r=new Map;this._systemMap=r;for(const e of t)r.set(e.constructor.name,e);this._logicUpdateArray=[],this._presentUpdateArray=[];for(const e of t){const t=e.createUpdateFuction(this),{logicUpdate:n,presentUpdate:r}=t;void 0!==n&&this._logicUpdateArray.push(t),void 0!==r&&this._presentUpdateArray.push(t)}this._timeInfo={tickInterval:e,tick:0,tickTime:0,presentTime:0},this._maxTickPerframe=n}getSystem(t){const e=this._systemMap.get(t.name);if(void 0===e)throw new Error("No system named "+t.name);return e}update(t){const e=this._timeInfo;if(void 0===this._nextTickTime)return this._nextTickTime=t+e.tickInterval,e.tick=1,e.tickTime=e.tickInterval,e.presentTime=e.tickInterval,this._logicDelayTime=t-e.presentTime,this._logicUpdate(e),void this._presentUpdate(e);let n=0;for(;t>=this._nextTickTime;){e.tick++;const t=e.tick*e.tickInterval;if(e.tickTime=t,e.presentTime=t,this._nextTickTime+=e.tickInterval,this._logicUpdate(e),++n>=this._maxTickPerframe)break}let r=t-this._logicDelayTime;const i=r-e.tickTime;i>=e.tickInterval&&(this._logicDelayTime+=i,r=e.tickTime,this._nextTickTime=t+e.tickInterval),e.presentTime=r,this._presentUpdate(e)}_logicUpdate(t){for(const e of this._logicUpdateArray)try{if(void 0===e.logicUpdate)throw new Error;e.logicUpdate(t)}catch(t){console.trace(t)}}_presentUpdate(t){for(const e of this._presentUpdateArray)try{if(void 0===e.presentUpdate)throw new Error;e.presentUpdate(t)}catch(t){console.trace(t)}}}class w{createUpdateFuction(t){return{}}}class _ extends w{constructor(){super(...arguments),this._queue=new Array}enqueue(t){this._queue.push(t)}createUpdateFuction(t){const{entityManager:e}=t;return{logicUpdate:()=>{for(const t of this._queue)e.deleteEntity(t);this._queue.length=0}}}}class m{constructor(t=0){this.tick=t}static createRawArray(t){return m.structDefine.createComponentRawArray(t)}}m.structDefine=new t({read(t){const e=new m;return e.tick=t.readInt32(),e},write(t,e){t.writeInt32(e.tick)},reset(t){t.writeInt32(0)}});class A extends w{createUpdateFuction(t){const{entityManager:e}=t,n=e.getQuery({include:[m]}),r=t.getSystem(_);return{logicUpdate:t=>{if(n.isEmptyIgnoreFilter())return;const{tick:e}=t;for(const t of n.iterChunks()){const n=t.getEntityArray(),i=t.getDataArray(m);if(null===i)throw new Error;for(let o=0;o<t.count;++o)i.get(o).tick<=e&&r.enqueue(n.get(o))}}}}}class x extends w{constructor(){super(...arguments),this._queue=new Array}enqueue(t,...e){this._queue.push({archetype:t,componentDataArray:e})}createUpdateFuction(t){const{entityManager:e}=t;return{logicUpdate:()=>{for(const{archetype:t,componentDataArray:n}of this._queue)e.createEntityOfArchetype(t,...n);this._queue.length=0}}}}class I extends w{constructor(){super(...arguments),this._queue=new Array}enqueue(t,...e){this._queue.push({entity:t,componentCtors:e})}createUpdateFuction(t){const{entityManager:e}=t;return{logicUpdate:()=>{for(const{entity:t,componentCtors:n}of this._queue)e.removeComponent(t,...n);this._queue.length=0}}}}class E{constructor(){this.beginTick=0,this.originX=0,this.originY=0,this.originZ=0,this.velocityX=0,this.velocityY=0,this.velocityZ=0}assignOrigin({x:t=0,y:e=0,z:n=0}){return this.originX=t,this.originY=e,this.originZ=n,this}assignVelocity({x:t=0,y:e=0,z:n=0}){return this.velocityX=t,this.velocityY=e,this.velocityZ=n,this}assignBeginTick(t){return this.beginTick=t,this}calculatePosition(t,e,n=0){if(t<=this.beginTick)return{x:this.originX,y:this.originY,z:this.originZ};const r=(t-this.beginTick)*e+n;return{x:this.originX+this.velocityX*r,y:this.originY+this.velocityY*r,z:this.originZ+this.velocityZ*r}}static createRawArray(t){return E.structDefine.createComponentRawArray(t)}}E.structDefine=new t({read(t){const e=new E;return e.beginTick=t.readInt32(),[e.originX,e.originY,e.originZ,e.velocityX,e.velocityY,e.velocityZ]=t.readMultipleFloat32(6),e},write(t,e){t.writeInt32(e.beginTick),t.writeMultipleFloat32(e.originX,e.originY,e.originZ,e.velocityX,e.velocityY,e.velocityZ)},reset(t){t.writeInt32(0),t.writeMultipleFloat32(0,0,0,0,0,0)}});class C extends w{createUpdateFuction(t){const{entityManager:e}=t,n=e.getQuery({include:[E,o]}),r=t=>{const{tick:e,tickInterval:r}=t;if(n.isEmptyIgnoreFilter())return;const i=t.presentTime-t.tickTime;for(const t of n.iterChunks()){const n=t.getDataArray(E);if(null===n)throw new Error;const s=t.getDataArray(o);if(null===s)throw new Error;for(let a=0;a<t.count;++a){const t=n.get(a);if(e<=t.beginTick){s.set(a,new o(t.originX,t.originY,t.originZ));continue}const{x:c,y:h,z:u}=t.calculatePosition(e,r,i);s.set(a,new o(c,h,u))}}};return{logicUpdate:r,presentUpdate:r}}}const v=9007199254740992,D=v-1,M=-1>>>0,k=M+1,b=k/2,L=b-1,T=1<<21,S=T-1;function int32(t){return 0|t.next()}function add(t,e){return 0===e?t:n=>t(n)+e}function int53(t){const e=0|t.next(),n=t.next()>>>0;return(e&S)*k+n+(e&T?-v:0)}function int53Full(t){for(;;){const e=0|t.next();if(!(4194304&e)){const n=t.next()>>>0;return(e&S)*k+n+(e&T?-v:0)}if(4194304==(8388607&e)&&0==(0|t.next()))return v}}function uint32(t){return t.next()>>>0}function uint53(t){const e=t.next()&S,n=t.next()>>>0;return e*k+n}function uint53Full(t){for(;;){const e=0|t.next();if(!(e&T)){const n=t.next()>>>0;return(e&S)*k+n}if(0==(e&S)&&0==(0|t.next()))return v}}function isPowerOfTwoMinusOne(t){return 0==(t+1&t)}function downscaleToRange(t){return isPowerOfTwoMinusOne(t)?(e=t,t=>t.next()&e):function(t){const e=t+1,n=e*Math.floor(k/e);return t=>{let r=0;do{r=t.next()>>>0}while(r>=n);return r%e}}(t);var e}function upscaleWithinU53(t){const e=t+1;if(0==(0|e)){const t=(e/k|0)-1;if(isPowerOfTwoMinusOne(t))return n=t,t=>{const e=t.next()&n,r=t.next()>>>0;return e*k+r}}var n;return function(t){const e=t*Math.floor(v/t);return n=>{let r=0;do{const t=n.next()&S,e=n.next()>>>0;r=t*k+e}while(r>=e);return r%t}}(e)}function upscaleWithinI53AndLoopCheck(t,e){return n=>{let r=0;do{const t=0|n.next(),e=n.next()>>>0;r=(t&S)*k+e+(t&T?-v:0)}while(r<t||r>e);return r}}function integer(t,e){if(t=Math.floor(t),e=Math.floor(e),t<-v||!isFinite(t))throw new RangeError(`Expected min to be at least ${-v}`);if(e>v||!isFinite(e))throw new RangeError(`Expected max to be at most ${v}`);const n=e-t;return n<=0||!isFinite(n)?()=>t:n===M?0===t?uint32:add(int32,t+b):n<M?add(downscaleToRange(n),t):n===D?add(uint53,t):n<D?add(upscaleWithinU53(n),t):e-1-t===D?add(uint53Full,t):t===-v&&e===v?int53Full:t===-v&&e===D?int53:t===-D&&e===v?add(int53,1):e===v?add(upscaleWithinI53AndLoopCheck(t-1,e-1),1):upscaleWithinI53AndLoopCheck(t,e)}function isLeastBitTrue(t){return 1==(1&t.next())}function lessThan(t,e){return n=>t(n)<e}function bool(t,e){return null==e?null==t?isLeastBitTrue:function(t){if(t<=0)return()=>!1;if(t>=1)return()=>!0;{const e=t*k;return e%1==0?lessThan(int32,e-b|0):lessThan(uint53,Math.round(t*v))}}(t):t<=0?()=>!1:t>=e?()=>!0:lessThan(integer(0,e-1),t)}function die(t){return integer(1,t)}const O="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-";function string(t=O){const e=t.length;if(!e)throw new Error("Expected pool not to be an empty string");const n=integer(0,e-1);return(e,r)=>{let i="";for(let o=0;o<r;++o){const r=n(e);i+=t.charAt(r)}return i}}const F=string("0123456789abcdef"),R=string("0123456789abcdef".toUpperCase());function convertSliceArgument(t,e){return t<0?Math.max(t+e,0):Math.min(t,e)}function toInteger(t){const e=+t;return e<0?Math.ceil(e):Math.floor(e)}function realZeroToOneExclusive(t){return uint53(t)/v}function realZeroToOneInclusive(t){return uint53Full(t)/v}const U=Array.prototype.slice;function shuffle(t,e,n=0){const r=e.length;if(r)for(let i=r-1>>>0;i>n;--i){const n=integer(0,i)(t);if(i!==n){const t=e[i];e[i]=e[n],e[n]=t}}return e}const P=(()=>{try{if("xxx"==="x".repeat(3))return(t,e)=>t.repeat(e)}catch(t){}return(t,e)=>{let n="";for(;e>0;)1&e&&(n+=t),e>>=1,t+=t;return n}})();function zeroPad(t,e){return P("0",e-t.length)+t}const V={next:()=>Math.random()*k|0};class q{constructor(t=V){this.engine=t}int32(){return int32(this.engine)}uint32(){return uint32(this.engine)}uint53(){return uint53(this.engine)}uint53Full(){return uint53Full(this.engine)}int53(){return int53(this.engine)}int53Full(){return int53Full(this.engine)}integer(t,e){return integer(t,e)(this.engine)}realZeroToOneInclusive(){return realZeroToOneInclusive(this.engine)}realZeroToOneExclusive(){return realZeroToOneExclusive(this.engine)}real(t,e,n=!1){return function(t,e,n=!1){if(!isFinite(t))throw new RangeError("Expected min to be a finite number");if(!isFinite(e))throw new RangeError("Expected max to be a finite number");return add((r=n?realZeroToOneInclusive:realZeroToOneExclusive,1==(i=e-t)?r:0===i?()=>0:t=>r(t)*i),t);var r,i}(t,e,n)(this.engine)}bool(t,e){return bool(t,e)(this.engine)}pick(t,e,n){return function(t,e,n,r){const i=e.length;if(0===i)throw new RangeError("Cannot pick from an empty array");const o=null==n?0:convertSliceArgument(toInteger(n),i),s=void 0===r?i:convertSliceArgument(toInteger(r),i);if(o>=s)throw new RangeError(`Cannot pick between bounds ${o} and ${s}`);return e[integer(o,s-1)(t)]}(this.engine,t,e,n)}shuffle(t){return shuffle(this.engine,t)}sample(t,e){return function(t,e,n){if(n<0||n>e.length||!isFinite(n))throw new RangeError("Expected sampleSize to be within 0 and the length of the population");if(0===n)return[];const r=U.call(e),i=r.length;if(i===n)return shuffle(t,r,0);const o=i-n;return shuffle(t,r,o-1).slice(o)}(this.engine,t,e)}die(t){return die(t)(this.engine)}dice(t,e){return function(t,e){const n=die(t);return t=>{const r=[];for(let i=0;i<e;++i)r.push(n(t));return r}}(t,e)(this.engine)}uuid4(){return function(t){const e=t.next()>>>0,n=0|t.next(),r=0|t.next(),i=t.next()>>>0;return zeroPad(e.toString(16),8)+"-"+zeroPad((65535&n).toString(16),4)+"-"+zeroPad((n>>4&4095|16384).toString(16),4)+"-"+zeroPad((16383&r|32768).toString(16),4)+"-"+zeroPad((r>>4&65535).toString(16),4)+zeroPad(i.toString(16),8)}(this.engine)}string(t,e){return string(e)(this.engine,t)}hex(t,e){return function(t){return t?R:F}(e)(this.engine,t)}date(t,e){return function(t,e){const n=integer(+t,+e);return t=>new Date(n(t))}(t,e)(this.engine)}}const Z=(()=>{try{const t=new ArrayBuffer(4),e=new Int32Array(t);if(e[0]=b,e[0]===-b)return Int32Array}catch(t){}return Array})();const z=(()=>{try{if(-5===Math.imul(M,5))return Math.imul}catch(t){}return(t,e)=>{const n=65535&t,r=65535&e;return n*r+((t>>>16&65535)*r+n*(e>>>16&65535)<<16>>>0)|0}})(),N=624,X=N-1,Y=397,j=N-Y,B=2567483615;class W{constructor(){this.data=new Z(N),this.index=0,this.uses=0}static seed(t){return(new W).seed(t)}static seedWithArray(t){return(new W).seedWithArray(t)}static autoSeed(){return W.seedWithArray(function(t=V,e=16){const n=[];n.push(0|(new Date).getTime());for(let r=1;r<e;++r)n[r]=0|t.next();return n}())}next(){(0|this.index)>=N&&(refreshData(this.data),this.index=0);const t=this.data[this.index];return this.index=this.index+1|0,this.uses+=1,0|function(t){return t^=t>>>11,t^=t<<7&2636928640,(t^=t<<15&4022730752)^t>>>18}(t)}getUseCount(){return this.uses}discard(t){if(t<=0)return this;for(this.uses+=t,(0|this.index)>=N&&(refreshData(this.data),this.index=0);t+this.index>N;)t-=N-this.index,refreshData(this.data),this.index=0;return this.index=this.index+t|0,this}seed(t){let e=0;this.data[0]=e=0|t;for(let t=1;t<N;t=t+1|0)this.data[t]=e=z(e^e>>>30,1812433253)+t|0;return this.index=N,this.uses=0,this}seedWithArray(t){return this.seed(19650218),function(t,e){let n=1,r=0;const i=e.length;let o=0|Math.max(i,N),s=0|t[0];for(;(0|o)>0;--o)t[n]=s=(t[n]^z(s^s>>>30,1664525))+(0|e[r])+(0|r)|0,++r,(0|(n=n+1|0))>X&&(t[0]=t[X],n=1),r>=i&&(r=0);for(o=X;(0|o)>0;--o)t[n]=s=(t[n]^z(s^s>>>30,1566083941))-n|0,(0|(n=n+1|0))>X&&(t[0]=t[X],n=1);t[0]=b}(this.data,t),this}}function refreshData(t){let e=0,n=0;for(;(0|e)<j;e=e+1|0)n=t[e]&b|t[e+1|0]&L,t[e]=t[e+Y|0]^n>>>1^(1&n?B:0);for(;(0|e)<X;e=e+1|0)n=t[e]&b|t[e+1|0]&L,t[e]=t[e-j|0]^n>>>1^(1&n?B:0);n=t[X]&b|t[0]&L,t[X]=t[Y-1]^n>>>1^(1&n?B:0)}class ${constructor(t=null){this._object3d=t}get object3d(){if(null===this._object3d)throw new Error;return this._object3d}static createRawArray(t){let e=$._empty;return null===e&&(e=new $(null),$._empty=e),new u(t,e)}}$.isSystemState=!0,$._empty=null;class Q extends w{createUpdateFuction(t){const{entityManager:e}=t,n=e.getQuery({include:[$],exclude:[i]}),r=e.getQuery({include:[$,o,i]}),s=t.getSystem(I);return{logicUpdate:function(t){if(!n.isEmptyIgnoreFilter())for(const t of n.iterChunks()){const e=t.getEntityArray(),n=t.getDataArray($);if(null===n)throw new Error;for(const t of e)s.enqueue(t,$);for(let e=0;e<t.count;++e)n.get(e).object3d.recycle()}},presentUpdate:function(t){if(!r.isEmptyIgnoreFilter())for(const t of r.iterChunks()){const e=t.getDataArray($),n=t.getDataArray(o);if(null===e)throw new Error;if(null===n)throw new Error;for(let r=0;r<t.count;++r){const t=n.get(r);e.get(r).object3d.setPosition(t)}}}}}}class H{static createRawArray(t){return new n(t,H.instance)}}H.instance=new H;class G extends w{constructor(t){super(),this._pool=t}createUpdateFuction(t){const e=t.getSystem(x),n=new q(W.autoSeed()),r=t.entityManager.getArchetype(H,E,o,$,m),i=()=>.1*function(t){return-Math.log(1-t)}(n.realZeroToOneExclusive());let s=i();return{logicUpdate:t=>{if(t.tickTime<s)return;s+=i();const o=function(t,e,n){const r=2*Math.PI*t,i=e+n,o=i>1?2-i:i;return{x:o*Math.cos(r),y:o*Math.sin(r)}}(n.realZeroToOneExclusive(),n.realZeroToOneExclusive(),n.realZeroToOneExclusive()),a=new Laya.Vector3(16*o.x,4*o.y,-20),c=new Laya.Vector3;Laya.Vector3.normalize(a,c),Laya.Vector3.scale(c,-1,c);const h=(new E).assignOrigin(a).assignVelocity(c).assignBeginTick(t.tick),u=new $(this._pool.spawn()),l=(Laya.Vector3.scalarLength(a)-.5)/1,y=Math.floor(l/t.tickInterval),f=new m(t.tick+y);e.enqueue(r,h,u,f)}}}}class J{constructor(){this._poolArray=null,this._recycled=!1}get recycled(){return this._recycled}recycle(){if(!this._recycled){if(this.setEnable(!1),null===this._poolArray)throw new Error;this._poolArray.push(this),this._recycled=!0}}}J.Pool=class{constructor(t){this._pool=new Array,this._createFunc=t}spawn(t=""){let e;return this._pool.length>0?(e=this._pool.pop()).setEnable(!0):(e=this._createFunc(t))._poolArray=this._pool,e._recycled=!1,e}};class K extends J.Pool{}class tt extends J{constructor(t,e){super(),this._scene3d=e,this._sprite3d=Laya.Sprite3D.instantiate(t,e)}setEnable(t){t?this._scene3d.addChild(this._sprite3d):this._sprite3d.removeSelf()}setPosition({x:t,y:e,z:n}){this._sprite3d.transform.position=new Laya.Vector3(t,e,n)}}class et{static createRawArray(t){return new n(t,et.instance)}}et.instance=new et;const nt=5,rt=5,it=2;class ot extends w{constructor(t){super(),this._velocity=new Laya.Vector3,this._pool=t}setShootDirection(t){Laya.Vector3.normalize(t,this._velocity),Laya.Vector3.scale(this._velocity,nt,this._velocity)}createUpdateFuction(t){const e=t.getSystem(x),n=t.entityManager.getArchetype(et,E,o,$,m);let r;return{logicUpdate:t=>{if(void 0===r)return void(r=t.tick+it);if(t.tick<=r)return;r+=it;const i=(new E).assignOrigin({y:-.2}).assignVelocity(this._velocity).assignBeginTick(t.tick),o=new $(this._pool.spawn()),s=Math.floor(rt/t.tickInterval),a=new m(t.tick+s);e.enqueue(n,i,o,a)}}}}const st=.2*.2;class at extends w{createUpdateFuction(t){const{entityManager:e}=t,n=e.getQuery({include:[H,o]}),r=e.getQuery({include:[et,o]}),i=t.getSystem(_);return{logicUpdate:function(){if(!n.isEmptyIgnoreFilter()&&!r.isEmptyIgnoreFilter())for(const t of n.iterChunks()){const e=t.getEntityArray(),n=t.getDataArray(o);if(null===n)throw new Error;for(const s of r.iterChunks()){const r=s.getEntityArray(),a=s.getDataArray(o);if(null===a)throw new Error;for(let o=0;o<t.count;++o){const t=n.get(o);for(let n=0;n<s.count;++n){const s=a.get(n),c=t.x-s.x,h=t.y-s.y,u=t.z-s.z;c*c+h*h+u*u<=st&&(i.enqueue(e.get(o)),i.enqueue(r.get(n)))}}}}}}}}var ct=Laya.Scene,ht=Laya.Scene3D,ut=Laya.Camera,lt=Laya.Vector3,yt=Laya.DirectionLight,ft=Laya.MeshSprite3D,dt=Laya.BlinnPhongMaterial,pt=Laya.PrimitiveMesh,gt=Laya.Texture2D,wt=Laya.Handler;class _t extends ct{constructor(){super();const t=Laya.stage.addChild(new ht),e=new ut(0,.01,40);t.addChild(e),t.enableFog=!0,t.fogStart=3,t.fogRange=20;const n=new yt;t.addChild(n),n.color=new lt(.6,.6,.6);const r=n.transform.worldMatrix;r.setForward(new lt(-1,-1,-1)),n.transform.worldMatrix=r;const i=new ft(pt.createPlane(10,10,10,10));t.addChild(i);const o=new dt;gt.load("res/grass.png",wt.create(this,t=>o.albedoTexture=t));{const t=o.tilingOffset;t.setValue(5,5,0,0),o.tilingOffset=t,i.meshRenderer.material=o}i.transform.translate(new lt(0,-1.5,0));const s=new ft(pt.createSphere(.1,4,8));{const t=new dt;gt.load("res/wood.jpg",wt.create(this,e=>t.albedoTexture=e));const e=t.tilingOffset;e.setValue(5,5,0,0),t.tilingOffset=e,s.meshRenderer.material=t}const a=new ft(pt.createSphere(.1,6,12));{const t=new dt;gt.load("res/fabric_wool.jpg",wt.create(this,e=>t.albedoTexture=e)),a.meshRenderer.material=t}const c=function(t,e,n){const r=new K(()=>new tt(e,t)),i=new K(()=>new tt(n,t)),o=new ot(i),s=new Array;s.push(new G(r),o,new C,new at,new A,new I,new x,new _,new Q);const a=new g(s);return{update(t){a.update(t)},setShootDirection(t){o.setShootDirection(t)}}}(t,s,a);c.setShootDirection(new Laya.Vector3(0,0,-1)),Laya.timer.frameLoop(1,this,function(){const t=.001*Laya.timer.currTimer;c.update(t)});{let t=!1;const n=new Laya.Vector2,r=new lt,i=new lt;let o,s;Laya.stage.on(Laya.Event.MOUSE_DOWN,this,function(e){e.stopPropagation(),n.x=e.stageX,n.y=e.stageY,t=!0}),Laya.stage.on(Laya.Event.MOUSE_MOVE,this,function(o){if(o.stopPropagation(),!t)return;const s=o.stageX-n.x,a=o.stageY-n.y;n.x=o.stageX,n.y=o.stageY,r.x-=.2*a,r.y-=.2*s,e.transform.rotationEuler=r,e.transform.getForward(i),c.setShootDirection(i)}),Laya.stage.on(Laya.Event.MOUSE_UP,this,function(e){e.stopPropagation(),t=!1}),Laya.Log.enable(),Laya.Log.toggle(),Laya.Gyroscope.instance.on(Laya.Event.CHANGE,this,function(t,n){if(null==o||null==s)return console.log("onOrientationChange",t,n),Laya.Log.print(`onOrientationChange ${t} ${n.beta} ${n.gamma}`),o=n.beta,void(s=n.gamma);const a=n.beta-o,h=n.gamma-s;o=n.beta,s=n.gamma,r.x+=a,r.y+=3*h,e.transform.rotationEuler=r,e.transform.getForward(i),c.setShootDirection(i)})}}}class mt{constructor(){}static init(){(0,Laya.ClassUtils.regClass)("scenes/Shooting.ts",_t)}}mt.width=640,mt.height=1136,mt.scaleMode="fixedwidth",mt.screenMode="none",mt.alignV="top",mt.alignH="left",mt.startScene="Shooting.scene",mt.sceneRoot="",mt.debug=!1,mt.stat=!1,mt.physicsDebug=!1,mt.exportSceneToJson=!0,mt.init();new class{constructor(){window.Laya3D?Laya3D.init(mt.width,mt.height):Laya.init(mt.width,mt.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=mt.scaleMode,Laya.stage.screenMode=mt.screenMode,Laya.stage.alignV=mt.alignV,Laya.stage.alignH=mt.alignH,Laya.URL.exportSceneToJson=mt.exportSceneToJson,(mt.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),mt.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),mt.stat&&Laya.Stat.show(),Laya.alertGlobalError=!0,Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}onConfigLoaded(){mt.startScene&&Laya.Scene.open(mt.startScene)}}}();